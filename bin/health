#!/usr/bin/env ruby
# encoding: utf-8

trap("INT")  {@working = false}
trap("TERM") {@working = false}

$: << File.expand_path("lib")

require "shushu"

PSMGR_VISDB = Sequel.connect(ENV["PSMGR_VISDB"])

@working = true
while(@working)
  service_count = PSMGR_VISDB[:services].filter("opened_at IS NOT NULL and closed_at IS NULL").count
  log(:level => :info, :action => "health_check", :query => "service_count", :count => service_count)

  event_count = Shushu::DB[:open_events].filter(:provider => 5).count
  log(:level => :info, :action => "health_check", :query => "billable_event_count", :count => event_count)

  sleep(1)
end
