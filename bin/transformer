#!/usr/bin/env ruby
# encoding: utf-8

trap("INT")  {@working = false}
trap("TERM") {@working = false}

require "./lib/shushu"

@limit = (ENV["TRANSFORM_LIMIT"] || 500).to_i
@working = true

while(@working)
  Utils.exec("SELECT transform($1)", @limit)
  close_events = Utils.exec("SELECT count(*) from close_events").pop["count"]
  log(:action => "transformer", :close_events => close_events)
  sleep(1)
end
